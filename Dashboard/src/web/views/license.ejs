<!doctype html>
<html lang="en">

<head>
	<%- include ("../partials/head") %>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/css/iziToast.min.css" integrity="sha512-O03ntXoVqaGUTAeAmvQ2YSzkCvclZEcPQu1eqloPaHfJ5RuNGiS4l+3duaidD801P50J28EHyonCV06CUlTSag==" crossorigin="anonymous" referrerpolicy="no-referrer" />
	<title>Zypher - License</title>
</head>

<body>
	<script src="/dist/js/demo-theme.min.js?1668287865"></script>
	<div class="page">
		<%- include ("../partials/navbar", { slt: "l" }) %>
			<div class="page-wrapper">
				<!-- Page header -->
				<div class="page-header d-print-none">
					<div class="container-xl">
						<div class="row g-2 align-items-center">
							<div class="col">
								<h2 class="page-title">
									<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-edit" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
										<path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
										<path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1"></path>
										<path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z"></path>
										<path d="M16 5l3 3"></path>
								 </svg>
									Edit a License Key
								</h2>
							</div>
						</div>
					</div>
				</div>
				<!-- Page body -->
				<div class="page-body">
					<div class="container-xl">
						<fieldset class="form-fieldset">
							<label class="form-label">User</label>
							<div class="input-icon mb-3">
								<span class="input-icon-addon">
									<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
										<path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
										<path d="M12 7m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0"></path>
										<path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
								 </svg>
								</span>
								<input id="user" value="<%= license.tag %>" type="text" class="form-control" autocomplete="off" readonly>
							</div>

							<label class="form-label">Discord ID</label>
							<div class="input-icon mb-3">
								<span class="input-icon-addon">
									<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-id" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
										<path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
										<path d="M3 4m0 3a3 3 0 0 1 3 -3h12a3 3 0 0 1 3 3v10a3 3 0 0 1 -3 3h-12a3 3 0 0 1 -3 -3z"></path>
										<path d="M9 10m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path>
										<path d="M15 8l2 0"></path>
										<path d="M15 12l2 0"></path>
										<path d="M7 16l10 0"></path>
								 </svg>
								</span>
								<input id="discord_id" value="<%= license.discord_id %>" type="text" class="form-control" autocomplete="off">
							</div>

							<label class="form-label">License</label>
							<div class="input-icon mb-3">
								<span class="input-icon-addon">
									<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-key" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
										<path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
										<path d="M16.555 3.843l3.602 3.602a2.877 2.877 0 0 1 0 4.069l-2.643 2.643a2.877 2.877 0 0 1 -4.069 0l-.301 -.301l-6.558 6.558a2 2 0 0 1 -1.239 .578l-.175 .008h-1.172a1 1 0 0 1 -.993 -.883l-.007 -.117v-1.172a2 2 0 0 1 .467 -1.284l.119 -.13l.414 -.414h2v-2h2v-2l2.144 -2.144l-.301 -.301a2.877 2.877 0 0 1 0 -4.069l2.643 -2.643a2.877 2.877 0 0 1 4.069 0z"></path>
										<path d="M15 9h.01"></path>
								 </svg>
								</span>
								<input id="license" value="<%= license.license %>" type="text" class="form-control" autocomplete="off" readonly>
							</div>
							
							<label class="form-label">Product</label>
							<div class="input-icon mb-3">
								<span class="input-icon-addon">
									<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-package" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
										<path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
										<path d="M12 3l8 4.5l0 9l-8 4.5l-8 -4.5l0 -9l8 -4.5"></path>
										<path d="M12 12l8 -4.5"></path>
										<path d="M12 12l0 9"></path>
										<path d="M12 12l-8 -4.5"></path>
										<path d="M16 5.25l-8 4.5"></path>
								 </svg>
								</span>
								<input id="product" value="<%= license.product_name %>" type="text" class="form-control" autocomplete="off">
							</div>

							<label class="form-label">Reason</label>
							<div class="input-icon mb-3">
								<span class="input-icon-addon">
								  <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-article" width="24"
									   height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
									   stroke-linecap="round" stroke-linejoin="round">
									<path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
									<path d="M3 4m0 2a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2z"></path>
									<path d="M7 8h10"></path>
									<path d="M7 12h10"></path>
									<path d="M7 16h10"></path>
								  </svg>
								</span>
								<input id="reason" value="<%= license.reason %>" type="text" class="form-control" autocomplete="off">
							</div>

							<label class="form-label">Created At</label>
							<div class="input-icon mb-3">
								<span class="input-icon-addon">
									<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
										<path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
										<path d="M4 5m0 2a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2z"></path>
										<path d="M16 3l0 4"></path>
										<path d="M8 3l0 4"></path>
										<path d="M4 11l16 0"></path>
										<path d="M11 15l1 0"></path>
										<path d="M12 15l0 3"></path>
								 </svg>
								</span>
								<input value="<%= license.createdAt.toLocaleDateString("en-US", { weekday: "long", year: "numeric", month: "long", day: "numeric" }) %>" type="text" class="form-control" autocomplete="off" readonly>
							</div>

							<label class="form-label readonly">Expires At (Currently: <%= license.expires_date?.toLocaleDateString("en-US", { weekday: "long", year: "numeric", month: "long", day: "numeric" }) || "Never" %>)</label>
							<div class="input-icon mb-3">
								<span class="input-icon-addon">
									<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-off" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
										<path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
										<path d="M19.823 19.824a2 2 0 0 1 -1.823 1.176h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 1.175 -1.823m3.825 -.177h9a2 2 0 0 1 2 2v9"></path>
										<path d="M16 3l0 4"></path>
										<path d="M8 3l0 1"></path>
										<path d="M4 11h7m4 0h5"></path>
										<path d="M11 15l1 0"></path>
										<path d="M12 15l0 3"></path>
										<path d="M3 3l18 18"></path>
								 </svg>
								</span>
								<input id="expiration" value="<%= license.expires_date?.toLocaleDateString("en-US", { weekday: "long", year: "numeric", month: "long", day: "numeric" }) || "Never" %>" type="number" class="form-control" autocomplete="off">
							</div>

							<label class="form-label">Latest IP</label>
							<div class="input-icon mb-3">
								<span class="input-icon-addon">
									<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chisel" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
										<path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
										<path d="M14 14l1.5 1.5"></path>
										<path d="M18.347 15.575l2.08 2.079a1.96 1.96 0 0 1 -2.773 2.772l-2.08 -2.079a1.96 1.96 0 0 1 2.773 -2.772z"></path>
										<path d="M3 6l3 -3l7.414 7.414a2 2 0 0 1 .586 1.414v2.172h-2.172a2 2 0 0 1 -1.414 -.586l-7.414 -7.414z"></path>
								 </svg>
								</span>
								<input value="<%= license.latest_ip || "Unknown" %>" type="text" class="form-control" autocomplete="off" readonly>
							</div>

							<label class="form-label">IP Cap <%= `${license.ip_list.length}/${license.ip_cap || "∞"}` %></label>
							<div class="input-icon mb-3">
								<span class="input-icon-addon">
									<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-forbid-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
										<path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
										<path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path>
										<path d="M9 15l6 -6"></path>
								 </svg>
								</span>
								<input id="ip_cap" value="<%= license.ip_cap %>" type="number" class="form-control" autocomplete="off">
							</div>

							<label class="form-label">HWID Cap <%= `${license.hwid_list.length}/${license.hwid_cap || "∞"}` %></label>
							<div class="input-icon mb-3">
								<span class="input-icon-addon">
									<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-forbid-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
										<path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
										<path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path>
										<path d="M9 15l6 -6"></path>
								 </svg>
								</span>
								<input id="hwid_cap" value="<%= license.hwid_cap %>" type="number" class="form-control" autocomplete="off">
							</div>

							<label class="form-label">IP List</label>
							<div class="input-icon mb-3">
								<span class="input-icon-addon">
									<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-forbid-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
										<path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
										<path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path>
										<path d="M9 15l6 -6"></path>
								 </svg>
								</span>
								<textarea style="resize: none;" rows="<%= license.ip_list.length || 1 %>" class="form-control" autocomplete="off" readonly><%= license.ip_list.map((ip,i) => `${i+1}: ${ip}`).join("\n") || "None" %></textarea>
							</div>

							<label class="form-label">HWID List</label>
							<div class="input-icon mb-3">
								<span class="input-icon-addon">
									<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-forbid-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
										<path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
										<path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path>
										<path d="M9 15l6 -6"></path>
								 </svg>
								</span>
								<textarea style="resize: none;" rows="<%= license.hwid_list.length || 1 %>" class="form-control" autocomplete="off" readonly><%= license.hwid_list.map((ip,i) => `${i+1}: ${ip}`).join("\n") || "None" %></textarea>
							</div>

							<div class="text-end">
								<button onclick="updateLicense('<%= license.license %>')" class="btn btn-primary">Update</button>
							</div>
						</fieldset>
					</div>
				</div>
				<%- include ("../partials/footer") %>
			</div>
	</div>
	<script>
		const $expiration = document.getElementById("expiration");
		const user = document.getElementById("user");
		const discord_id = document.getElementById("discord_id");
		const license = document.getElementById("license");
		const product = document.getElementById("product");
		const ip_cap = document.getElementById("ip_cap");
		const hwid_cap = document.getElementById("hwid_cap");
		const reason = document.getElementById("reason");
		
		// check if $expiration is an integer
		$expiration.addEventListener("input", () => {
			if (isNaN(parseInt($expiration.value))) {
				$expiration.value = 0;
			}
		});

		async function updateLicense(query) {
			let licenseObject = {};
			
			if ($expiration == 0) {
				licenseObject = {
					discord_id: discord_id.value,
					license: license.value,
					product_name: product.value,
					reason: reason.value,
					ip_cap: ip_cap.value,
					hwid_cap: hwid_cap.value,
				};
			} else {
				licenseObject = {
					discord_id: discord_id.value,
					license: license.value,
					product_name: product.value,
					reason: reason.value,
					ip_cap: ip_cap.value,
					hwid_cap: hwid_cap.value,
					expiresDays: parseInt($expiration.value)
				};
			}

			const res = await fetch(`/api/web/licenses/${query}`, {
				method: "PATCH",
				body: JSON.stringify(licenseObject),
				headers: {
					"Content-Type": "application/json"
				}
			});

			const data = await res.json();
				if (res.status !== 200) {
					return iziToast.show({
			  title: data?.message || "Something went wrong!",
			  color: "red",
			  position: "topRight",
			  layout: 1,
			  icon: "iziToast-icon ico-error revealIn"
			});
			}

	  return iziToast.show({
        title: data?.message || "License updated correctly!",
        color: "green",
        position: "topRight",
        layout: 1,
        icon: "iziToast-icon ico-success revealIn",
        onClosing: () => {
			location.href = "../licenses";
        }
      });
		}
	
		discord_id.addEventListener("change", async (e) => {
			const res = await fetch(`/validate/discord/${e.target.value}`);
      const data = await res.json();

      if (res.status !== 200) {
        return iziToast.show({
          title: 'User not found',
          color: "red",
          position: "topRight",
          layout: 1,
          icon: "iziToast-icon ico-error revealIn"
        });
      };

			user.value = data.user.tag;

			return iziToast.show({
        title: 'User found correctly!',
        color: "green",
        position: "topRight",
        layout: 1,
        icon: "iziToast-icon ico-success revealIn"
      });
		});
	</script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/js/iziToast.min.js" integrity="sha512-Zq9o+E00xhhR/7vJ49mxFNJ0KQw1E1TMWkPTxrWcnpfEFDEXgUiwJHIKit93EW/XxE31HSI5GEOW06G6BF1AtA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="/dist/js/tabler.min.js?1668287865" defer></script>
	<script src="/dist/js/demo.min.js?1668287865" defer></script>
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-5PE1JS9ZWW"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());
	
	  gtag('config', 'G-5PE1JS9ZWW');
	</script>
</body>

</html>