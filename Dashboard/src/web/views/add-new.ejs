<!doctype html>
<html lang="en">
<head>
  <%- include ("../partials/head") %>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/css/iziToast.min.css"
      integrity="sha512-O03ntXoVqaGUTAeAmvQ2YSzkCvclZEcPQu1eqloPaHfJ5RuNGiS4l+3duaidD801P50J28EHyonCV06CUlTSag=="
      crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>Zypher - Add License</title>
</head>

<body>
  <script src="/dist/js/demo-theme.min.js?1668287865"></script>
  <div class="page">
    <%- include ("../partials/navbar", { slt: "l" }) %>
      <div class="page-wrapper">
        <!-- Page header -->
        <div class="page-header d-print-none">
          <div class="container-xl">
            <div class="row g-2 align-items-center">
              <div class="col">
                <h2 class="page-title">
                  Create New License
                </h2>
              </div>
            </div>
          </div>
        </div>
        <!-- Page body -->
        <div class="page-body">
          <div class="container-xl">
            <fieldset id="fieldset" class="form-fieldset">
              <label id="user-label" class="form-label required">User ID</label>
              <div class="input-group mb-3">
                <span class="input-group-text">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24"
                    height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                    <path d="M12 7m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0"></path>
                    <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
                  </svg>
                </span>
                <input id="user" type="text" class="form-control" autocomplete="off">
              </div>

              <label class="form-label required">Product</label>
              <div class="input-group mb-3">
                <span class="input-group-text">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-package" width="24"
                    height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                    <path d="M12 3l8 4.5l0 9l-8 4.5l-8 -4.5l0 -9l8 -4.5"></path>
                    <path d="M12 12l8 -4.5"></path>
                    <path d="M12 12l0 9"></path>
                    <path d="M12 12l-8 -4.5"></path>
                    <path d="M16 5.25l-8 4.5"></path>
                  </svg>
                </span>

                <select id="product" class="form-select">
                  <% products.forEach(({name})=> { %>
                    <option value="<%= name %>">
                      <%= name %>
                    </option>
                    <% }) %>
                </select>
              </div>

              <label class="form-label required">License Key</label>
              <div class="input-group mb-3">
                <span class="input-group-text">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-key" width="24"
                    height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                    <path
                      d="M16.555 3.843l3.602 3.602a2.877 2.877 0 0 1 0 4.069l-2.643 2.643a2.877 2.877 0 0 1 -4.069 0l-.301 -.301l-6.558 6.558a2 2 0 0 1 -1.239 .578l-.175 .008h-1.172a1 1 0 0 1 -.993 -.883l-.007 -.117v-1.172a2 2 0 0 1 .467 -1.284l.119 -.13l.414 -.414h2v-2h2v-2l2.144 -2.144l-.301 -.301a2.877 2.877 0 0 1 0 -4.069l2.643 -2.643a2.877 2.877 0 0 1 4.069 0z">
                    </path>
                    <path d="M15 9h.01"></path>
                  </svg>
                </span>

                <input readonly id="license" type="text" class="form-control" autocomplete="off">

                <button class="btn btn-outline" type="button" onclick="generateLicense()">Autofill</button>
                <button class="btn btn-outline btn-icon" type="button" onclick="toggleLicenseEdit()">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-pencil" width="24"
                    height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                    <path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4"></path>
                    <path d="M13.5 6.5l4 4"></path>
                  </svg>
                </button>
              </div>

              <label class="form-label">Expiration Days</label>
              <div class="input-group mb-3">
                <span class="input-group-text">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar" width="24"
                    height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                    <path d="M4 5m0 2a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2z"></path>
                    <path d="M16 3l0 4"></path>
                    <path d="M8 3l0 4"></path>
                    <path d="M4 11l16 0"></path>
                    <path d="M11 15l1 0"></path>
                    <path d="M12 15l0 3"></path>
                  </svg>
                </span>

                <input type="number" id="expiration" class="form-control"
                  placeholder="Set the expiration days (leave empty for lifetime)" value="">
              </div>

              <label class="form-label">Reason</label>
              <div class="input-group mb-3">
                <span class="input-group-text">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-article" width="24"
                    height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                    <path d="M3 4m0 2a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2z"></path>
                    <path d="M7 8h10"></path>
                    <path d="M7 12h10"></path>
                    <path d="M7 16h10"></path>
                  </svg>
                </span>
                <input id="reason" type="text" class="form-control" autocomplete="off">
              </div>

              <label class="form-label required">IP Cap</label>
              <div class="input-group mb-3">
                <span class="input-group-text">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-forbid-2" width="24"
                    height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                    <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path>
                    <path d="M9 15l6 -6"></path>
                  </svg>
                </span>
                <input id="ip_cap" value="3" type="number" class="form-control" autocomplete="off">
              </div>

              <label class="form-label required">HWID Cap</label>
              <div class="input-group mb-3">
                <span class="input-group-text">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chisel" width="24"
                    height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                    <path d="M14 14l1.5 1.5"></path>
                    <path
                      d="M18.347 15.575l2.08 2.079a1.96 1.96 0 0 1 -2.773 2.772l-2.08 -2.079a1.96 1.96 0 0 1 2.773 -2.772z">
                    </path>
                    <path
                      d="M3 6l3 -3l7.414 7.414a2 2 0 0 1 .586 1.414v2.172h-2.172a2 2 0 0 1 -1.414 -.586l-7.414 -7.414z">
                    </path>
                  </svg>
                </span>
                <input id="hwid_cap" value="3" type="numer" class="form-control" autocomplete="off">
              </div>

              <div class="text-end">
                <button onclick="createLicense()" type="button" class="btn btn-success">Create</button>
              </div>
            </fieldset>
          </div>
        </div>
        <%- include ("../partials/footer") %>
      </div>
  </div>
  <script>
    const $expiration = document.getElementById("expiration");
    const fieldset = document.getElementById("user-label");
    const $product = document.getElementById("product");
    const $license = document.getElementById("license");
    const $reason = document.getElementById("reason");
    const $hwid = document.getElementById("hwid_cap");
    const $user = document.getElementById("user");
    const $ip = document.getElementById("ip_cap");

    function generateLicense() {
      const strings = "ABCDEFGHIJKLMNIOPQRSTUVWXYZ0123456789";
      let license = "";

      for (let i = 0; i < 25; i++) {
        license += strings[Math.floor(Math.random() * strings.length)];
      }

      license = license.replace(/([a-zA-Z0-9]{5})/g, "$1-").slice(0, -1);
      $license.value = license;
    }

    function resetDate() {
      $expiration.value = "";
    }

    async function createLicense() {      
      const licenseObject = {
        product_name: $product.selectedOptions[0].value,
        reason: $reason.value || null,
        license: $license.value,
        discord_id: $user.value,
        ip_cap: parseInt($ip.value),
        hwid_cap: parseInt($hwid.value),
        expiresDays: parseInt($expiration.value) || null,
      };

      const res = await fetch("/api/web/licenses", {
        method: "POST",
        body: JSON.stringify(licenseObject),
        headers: {
          "Content-Type": "application/json"
        }
      });

      const data = await res.json();
      if (res.status !== 201) {
        return iziToast.show({
          title: data?.message || "Something went wrong!",
          color: "red",
          position: "topRight",
          layout: 1,
          icon: "iziToast-icon ico-error revealIn"
        });
      };

      return iziToast.show({
        title: data?.message || "License created correctly!",
        color: "green",
        position: "topRight",
        layout: 1,
        icon: "iziToast-icon ico-success revealIn",
        onClosing: () => {
          location.reload()
        }
      });
    }

    function toggleLicenseEdit() {
      const $license = document.getElementById("license");
      const active = $license.getAttribute("readonly") !== null;

      if (active) return $license.removeAttribute("readonly");
      $license.setAttribute("readonly", true);
    }

    $user.addEventListener("change", async (e) => {
      const res = await fetch(`/validate/discord/${e.target.value}`);
      const data = await res.json();

      if (res.status !== 200) {
        return iziToast.show({
          title: 'User not found',
          color: "red",
          position: "topRight",
          layout: 1,
          icon: "iziToast-icon ico-error revealIn"
        });
      };

      $user.setAttribute("readonly", true);

      const label = document.createElement("label");
      label.className = "form-label required";
      label.innerHTML += "User Tag";

      const div = document.createElement("div");
      div.className = "input-group mb-3";

      const span = document.createElement("span");
      span.className = "input-group-text";

      const svg = document.createElement("div");
      svg.innerHTML += `<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M12 7m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0"></path><path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path></svg>`;

      const input = document.createElement("input");
      input.type = "text";
      input.className = "form-control";
      input.value = data.user.tag;
      input.setAttribute("readonly", true);

      div.appendChild(span);
      span.appendChild(svg);
      div.appendChild(input);

      fieldset.before(label)
      fieldset.before(div);

      return iziToast.show({
        title: 'User found correctly!',
        color: "green",
        position: "topRight",
        layout: 1,
        icon: "iziToast-icon ico-success revealIn"
      });
    });

    document.addEventListener("DOMContentLoaded", function () {
      generateLicense();
    });
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/js/iziToast.min.js"
    integrity="sha512-Zq9o+E00xhhR/7vJ49mxFNJ0KQw1E1TMWkPTxrWcnpfEFDEXgUiwJHIKit93EW/XxE31HSI5GEOW06G6BF1AtA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="/dist/js/tabler.min.js?1668287865" defer></script>
  <script src="/dist/js/demo.min.js?1668287865" defer></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-5PE1JS9ZWW"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'G-5PE1JS9ZWW');
  </script>
</body>

</html>